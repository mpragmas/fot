// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///
enum Role {
  FAN
  REPORTER
  ADMIN
  SUPER_ADMIN
}

enum MatchStatus {
  UPCOMING
  LIVE
  COMPLETED
}

enum MatchPhase {
  PRE
  FIRST_HALF
  HT
  SECOND_HALF
  ET
  FT
}

enum StatType {
  GOAL
  ASSIST
  OWN_GOAL
  PENALTY_GOAL
  YELLOW_CARD
  RED_CARD
  SHOT
  CORNER
  SUBSTITUTION
}

enum AbsenceType {
  RED_CARD
  FIVE_YELLOW_CARDS
  INJURY
  PERSONAL
}

enum ProposalStatus {
  PENDING
  APPROVED
  REJECTED
}



enum NewsStatus {
  DRAFT
  PUBLISHED
 
}





// ------------------------ USERS ------------------------
model User {
  id                   Int       @id @default(autoincrement())
  name                 String
  email                String    @unique
  password             String
  emailVerified        DateTime?
  role                 Role      @default(FAN)
  Image           String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  isActive             Boolean   @default(true)

   resetToken     String?  // new
  resetTokenExp  DateTime? // new

  // Relations
  news                 News[]
  matches              Match[]   @relation("ReporterMatches")
  proposedTransfers    ProposedTransfer[]
  approvedTransfers    Transfer[] @relation("ApprovedTransfers")


}

// ------------------------ LEAGUES & SEASONS ------------------------
model League {
  id          Int       @id @default(autoincrement())
  name        String
  country     String
  seasons     Season[]
  teams       Team[]
  leagueTables LeagueTable[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Season {
  id          Int       @id @default(autoincrement())
  year        String
  league      League    @relation(fields: [leagueId], references: [id])
  leagueId    Int
  startDate   DateTime
  endDate     DateTime
  totalRounds Int?
  fixtures    Fixture[]
  playerStats PlayerStat[]
  leagueTables LeagueTable[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ------------------------ TEAMS & PLAYERS ------------------------
model Team {
  id               Int       @id @default(autoincrement())
  name             String
  league           League    @relation(fields: [leagueId], references: [id])
  leagueId         Int
  coach          String?
 location         String?
  logo             String?
  players          Player[]
  homeFixtures     Fixture[] @relation("HomeFixtures")
  awayFixtures     Fixture[] @relation("AwayFixtures")
  fromTransfers    Transfer[] @relation("FromTransfers")
  toTransfers      Transfer[] @relation("ToTransfers")
  proposedTransfers ProposedTransfer[]
  leagueTables      LeagueTable[]
  isActive         Boolean   @default(true)
  deactivatedAt    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Player {
  id           Int       @id @default(autoincrement())
  firstName    String
  lastName     String?
  position     String
  age          Int?
  number       Int?
  image        String?
  team         Team?     @relation(fields: [teamId], references: [id])
  teamId       Int?
  stats        PlayerStat[]
  lineups      Lineup[]
  matchStats   MatchStat[]
  transfers    Transfer[]
  absences     MatchAbsence[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// ------------------------ FIXTURES & MATCHES ------------------------
model Fixture {
  id          Int       @id @default(autoincrement())
  season      Season    @relation(fields: [seasonId], references: [id])
  seasonId    Int
  homeTeam    Team      @relation("HomeFixtures", fields: [homeTeamId], references: [id])
  homeTeamId  Int
  awayTeam    Team      @relation("AwayFixtures", fields: [awayTeamId], references: [id])
  awayTeamId  Int
  match       Match?
  date        DateTime
  stadium     String?
  referee     String?
  roundNumber Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([seasonId, roundNumber, date])
}

model Match {
  id          Int       @id @default(autoincrement())
  fixture     Fixture   @relation(fields: [fixtureId], references: [id])
  fixtureId   Int       @unique
  status      MatchStatus @default(UPCOMING)
  // Authoritative clock state
  phase              MatchPhase @default(PRE)
  elapsedSeconds     Int        @default(0)
  clockStartedAt     DateTime?
  homeScore         Int        @default(0)
  awayScore         Int        @default(0)
  reporter    User?     @relation("ReporterMatches", fields: [reporterId], references: [id])
  reporterId  Int?
  lineups     Lineup[]
  stats       MatchStat[]
  counters   MatchCounters?
  absences    MatchAbsence[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model MatchCounters {
  id               Int      @id @default(autoincrement())
  match            Match    @relation(fields: [matchId], references: [id])
  matchId          Int      @unique
  homeShotsOnTarget Int     @default(0)
  awayShotsOnTarget Int     @default(0)
  homeCorners       Int     @default(0)
  awayCorners       Int     @default(0)
  updatedAt         DateTime @updatedAt
}

// ------------------------ LEAGUE TABLE ------------------------

model LeagueTable {
  id            Int      @id @default(autoincrement())
  league        League   @relation(fields: [leagueId], references: [id])
  leagueId      Int
  season        Season   @relation(fields: [seasonId], references: [id])
  seasonId      Int
  team          Team     @relation(fields: [teamId], references: [id])
  teamId        Int
  played        Int      @default(0)
  wins          Int      @default(0)
  draws         Int      @default(0)
  losses        Int      @default(0)
  goalsFor      Int      @default(0)
  goalsAgainst  Int      @default(0)
  goalDiff      Int      @default(0)
  points        Int      @default(0)
  updatedAt     DateTime @updatedAt

  @@unique([leagueId, seasonId, teamId], name: "LeagueTable_league_season_team_unique")
  @@index([leagueId, seasonId, points, goalDiff], name: "LeagueTable_league_season_points_goalDiff_idx")
}

// ------------------------ LINEUPS & MATCH STATS ------------------------
model Lineup {
  id          Int       @id @default(autoincrement())
  match       Match     @relation(fields: [matchId], references: [id])
  matchId     Int
  player      Player    @relation(fields: [playerId], references: [id])
  playerId    Int
  position    String
  isStarting  Boolean   @default(false)
}

model MatchAbsence {
  id       Int         @id @default(autoincrement())
  match    Match       @relation(fields: [matchId], references: [id])
  matchId  Int
  player   Player      @relation(fields: [playerId], references: [id])
  playerId Int
  type     AbsenceType
  note     String?

  @@unique([matchId, playerId])
}

model MatchStat {
  id          Int       @id @default(autoincrement())
  match       Match     @relation(fields: [matchId], references: [id])
  matchId     Int
  player      Player    @relation(fields: [playerId], references: [id])
  playerId    Int
  type        StatType
  minute      Int
  half        Int?
  createdAt   DateTime  @default(now())
}

// ------------------------ PLAYER STATS ------------------------
model PlayerStat {
  id          Int       @id @default(autoincrement())
  player      Player    @relation(fields: [playerId], references: [id])
  playerId    Int
  season      Season    @relation(fields: [seasonId], references: [id])
  seasonId    Int
  gamesPlayed Int       @default(0)
  goals       Int       @default(0)
  assists     Int       @default(0)
  yellowCards Int       @default(0)
  redCards    Int       @default(0)
}

// ------------------------ TRANSFERS ------------------------
model Transfer {
  id          Int       @id @default(autoincrement())
  player      Player    @relation(fields: [playerId], references: [id])
  playerId    Int
  fromTeam    Team?     @relation("FromTransfers", fields: [fromTeamId], references: [id])
  fromTeamId  Int?
  toTeam      Team      @relation("ToTransfers", fields: [toTeamId], references: [id])
  toTeamId    Int
  approvedBy  User?     @relation("ApprovedTransfers", fields: [approvedById], references: [id])
  approvedById Int?
  createdAt   DateTime  @default(now())
}

model ProposedTransfer {
  id          Int       @id @default(autoincrement())
  playerName  String
  proposedBy  User      @relation(fields: [proposedById], references: [id])
  proposedById Int
  team        Team      @relation(fields: [teamId], references: [id])
  teamId      Int
  status      ProposalStatus @default(PENDING)
  createdAt   DateTime  @default(now())
}

// ------------------------ NEWS & COMMENTS ------------------------

model News {
  id          Int        @id @default(autoincrement())
  title       String
  slug        String     @unique
  content     String     @db.Text
  coverImage  String?
  status      NewsStatus @default(DRAFT)

  author      User       @relation(fields: [authorId], references: [id])
  authorId    Int

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}
